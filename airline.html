<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>èˆªç­è¦åŠƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap");
      body {
        font-family: "Noto Sans TC", sans-serif;
        background-color: #f0f4f8;
      }
      .card {
        transition: all 0.3s ease;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        -webkit-appearance: none;
        appearance: none;
      }
      .tab-btn {
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
      }
      .tab-btn.active {
        border-color: #0d9488;
        color: #0f766e;
        background-color: #f0fdfa;
      }
      optgroup {
        font-weight: bold;
        color: #475569;
      }
    </style>
  </head>
  <body class="text-slate-800 pb-20">
    <!-- Navigation / Header -->
    <nav class="bg-white shadow-sm border-b border-slate-100 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
          <!-- Logo/Brand -->
          <div class="flex items-center">
            <span class="text-xl md:text-2xl font-bold text-sky-600" data-key="nav.brand">2026El Nido</span>
          </div>

          <!-- Center Navigation Links - Desktop -->
          <div class="hidden md:flex items-center space-x-6">
            <a
              href="index.html"
              class="text-slate-600 hover:text-sky-600 font-medium border-b-2 border-transparent hover:border-sky-300 pb-1 transition-colors text-dynamic"
              data-key="nav.home"
            >
              é¦–é 
            </a>
            <a
              href="airline.html"
              class="text-slate-900 hover:text-sky-600 font-medium border-b-2 border-sky-600 pb-1 transition-colors text-dynamic"
              data-key="nav.airline"
            >
              èˆªç­è¦åŠƒ
            </a>
          </div>

          <!-- Right Side: Language Selector + Mobile Menu -->
          <div class="flex items-center space-x-3">
            <!-- Language Toggle -->
            <div class="relative inline-block text-left">
              <select
                id="language-selector"
                onchange="switchLanguage(this.value)"
                class="bg-white border border-slate-300 rounded-md shadow-sm pl-3 pr-8 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 cursor-pointer"
              >
                <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ç¹ä¸­</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
              </select>
            </div>

            <!-- Mobile Menu Button -->
            <button
              id="mobile-menu-btn"
              onclick="toggleMobileMenu()"
              class="md:hidden p-2 rounded-md text-slate-600 hover:text-sky-600 hover:bg-slate-100 transition-colors"
              aria-label="Menu"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden pb-4 pt-2 space-y-2">
          <a
            href="index.html"
            class="block px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-md font-medium text-dynamic"
            data-key="nav.home"
          >
            é¦–é 
          </a>
          <a
            href="airline.html"
            class="block px-4 py-2 text-slate-900 bg-sky-50 rounded-md font-medium text-dynamic"
            data-key="nav.airline"
          >
            èˆªç­è¦åŠƒ
          </a>
        </div>
      </div>
    </nav>

    <div class="max-w-5xl mx-auto p-4 md:p-8">
      <!-- Header -->
      <header class="text-center mb-8 mt-4">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2" data-key="page.title">ğŸŒ´ æ„›å¦®å³¶ (ENI) èˆªç­è¦åŠƒ</h1>
        <p class="text-slate-500" data-key="page.subtitle">2026/5/21 å‡ºç™¼ âœ 5/24 æˆ– 5/25 å›ç¨‹</p>
      </header>

      <!-- OUTBOUND SECTION -->
      <section class="mb-10 relative">
        <div class="absolute -left-4 top-0 bottom-0 w-1 bg-blue-500 rounded-full hidden md:block"></div>
        <div class="flex items-center mb-6">
          <div class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3 shadow-lg">1</div>
          <h2 class="text-2xl font-bold text-slate-700" data-key="outbound.title">å»ç¨‹ï¼š2026/5/21 (é€±å››)</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
          <!-- TPE Flight -->
          <div class="md:col-span-4 card bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <label class="block text-sm font-semibold text-slate-500 mb-2" data-key="outbound.tpe_label">ğŸ‡¹ğŸ‡¼ TPE æŠµé” MNL</label>
            <select
              id="out_tpe"
              class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3"
            >
              <option value="" disabled selected>é¸æ“‡èˆªç­...</option>
              <!-- Populated by JavaScript -->
            </select>
            <div id="res_out_tpe" class="mt-3 hidden text-sm"></div>
          </div>

          <!-- NRT Flight -->
          <div class="md:col-span-4 card bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <label class="block text-sm font-semibold text-slate-500 mb-2" data-key="outbound.nrt_label">ğŸ‡¯ğŸ‡µ NRT æŠµé” MNL</label>
            <select
              id="out_nrt"
              class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3"
            >
              <option value="" disabled selected>é¸æ“‡èˆªç­...</option>
              <!-- Populated by JavaScript -->
            </select>
            <div id="res_out_nrt" class="mt-3 hidden text-sm"></div>
          </div>

          <!-- Shared AirSWIFT -->
          <div class="md:col-span-4 card bg-blue-50 p-5 rounded-xl shadow-md border border-blue-200 ring-2 ring-blue-100 relative">
            <div
              class="absolute -top-3 -right-3 bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-bold shadow-sm"
              data-key="outbound.meeting_point"
            >
              æœƒåˆé»
            </div>
            <label class="block text-sm font-bold text-blue-800 mb-2" data-key="outbound.eni_label">ğŸ‡µğŸ‡­ MNL -> ENI (å…±åŒæ­ä¹˜)</label>
            <select
              id="out_eni"
              class="w-full bg-white border border-blue-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3"
            >
              <option value="" disabled selected>é¸æ“‡ AirSWIFT...</option>
              <!-- Populated by JavaScript -->
            </select>
          </div>
        </div>
      </section>

      <!-- INBOUND SECTION -->
      <section class="mb-12 relative">
        <div class="absolute -left-4 top-0 bottom-0 w-1 bg-teal-500 rounded-full hidden md:block"></div>
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
          <div class="flex items-center mb-4 md:mb-0">
            <div class="bg-teal-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3 shadow-lg">2</div>
            <div>
              <span class="text-sm font-bold text-slate-500 mr-2" data-key="inbound.title_prefix">ENI å‡ºç™¼æ—¥æœŸï¼š</span>
              <div class="bg-slate-200 p-1 rounded-lg inline-flex">
                <button
                  onclick="setReturnDate('24')"
                  id="btn-24"
                  class="tab-btn active px-4 py-2 rounded-md font-medium text-slate-600 hover:bg-white text-sm shadow-sm"
                  data-key="inbound.date_24"
                >
                  5/24 (é€±æ—¥)
                </button>
                <button
                  onclick="setReturnDate('25')"
                  id="btn-25"
                  class="tab-btn px-4 py-2 rounded-md font-medium text-slate-600 hover:bg-white text-sm"
                  data-key="inbound.date_25"
                >
                  5/25 (é€±ä¸€)
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Dive Safety Reminder (Gentle Version) -->
        <div id="dive-warning" class="hidden mb-6 bg-sky-50 border-l-4 border-sky-400 p-4 rounded-r-lg shadow-sm">
          <div class="flex flex-col sm:flex-row sm:items-start">
            <div class="flex items-center mb-2 sm:mb-0 mt-1">
              <span class="text-2xl mr-3">ğŸ¤¿</span>
              <span class="font-bold text-sky-800 text-lg mr-2 whitespace-nowrap" data-key="dive.title">æ½›æ°´å“¡æº«é¦¨æé†’</span>
            </div>
            <div id="dive-msg" class="text-sky-700 text-sm font-medium w-full">
              <!-- Dynamic Content Here -->
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
          <!-- Shared AirSWIFT Inbound -->
          <div class="md:col-span-4 card bg-teal-50 p-5 rounded-xl shadow-md border border-teal-200 ring-2 ring-teal-100 relative">
            <div
              class="absolute -top-3 -left-3 bg-teal-600 text-white text-xs px-2 py-1 rounded-full font-bold shadow-sm"
              data-key="inbound.departure_point"
            >
              å‡ºç™¼é»
            </div>
            <label class="block text-sm font-bold text-teal-800 mb-2" data-key="inbound.eni_label">ğŸ‡µğŸ‡­ ENI -> MNL (å…±åŒæ­ä¹˜)</label>
            <select
              id="in_eni"
              class="w-full bg-white border border-teal-300 text-slate-900 text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-3"
            >
              <!-- Populated by JS -->
            </select>
          </div>

          <!-- TPE Flight Inbound -->
          <div class="md:col-span-4 card bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <label class="block text-sm font-semibold text-slate-500 mb-2" data-key="inbound.tpe_label">ğŸ‡¹ğŸ‡¼ MNL èµ·é£›å¾€ TPE</label>
            <select
              id="in_tpe"
              class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3"
            >
              <!-- Populated by JS -->
            </select>
            <div id="res_in_tpe" class="mt-3 hidden text-sm"></div>
          </div>

          <!-- NRT Flight Inbound -->
          <div class="md:col-span-4 card bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <label class="block text-sm font-semibold text-slate-500 mb-2" data-key="inbound.nrt_label">ğŸ‡¯ğŸ‡µ MNL èµ·é£›å¾€ NRT</label>
            <select
              id="in_nrt"
              class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3"
            >
              <!-- Populated by JS -->
            </select>
            <div id="res_in_nrt" class="mt-3 hidden text-sm"></div>
          </div>
        </div>
      </section>

      <!-- Summary Recommendation -->
      <div
        id="recommendation"
        class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl p-6 text-white shadow-xl hidden transform transition-all duration-500"
      >
        <h3 class="text-lg font-bold mb-3 border-b border-slate-600 pb-2" data-key="recommendation.title">âœ¨ è¡Œç¨‹åˆ†æèˆ‡å»ºè­°</h3>
        <div id="rec-content" class="text-slate-300 text-sm leading-relaxed space-y-2"></div>
      </div>
    </div>

    <script>
      // --- DATA ---

      let flightData = null;
      let eniInboundFlights = [];
      let tpeInboundFlights = [];
      let nrtInboundFlights = [];
      let tpeOutboundFlights = [];
      let nrtOutboundFlights = [];
      let eniOutboundFlights = [];

      let currentReturnDate = "24";

      // Helper function to convert time string (HH:MM) to minutes since midnight
      function timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(":").map(Number);
        return hours * 60 + minutes;
      }

      // Load flight data from JSON
      async function loadFlightData() {
        try {
          const response = await fetch("FlightData.json");
          flightData = await response.json();
          processFlightData();
          initializeUI();
        } catch (error) {
          console.error("Error loading flight data:", error);
        }
      }

      // Process JSON data into the format needed by the app
      function processFlightData() {
        // TPE -> MNL (Outbound: 2026/5/21)
        if (flightData["TPE-MNL"] && flightData["TPE-MNL"]["2026/5/21"]) {
          tpeOutboundFlights = flightData["TPE-MNL"]["2026/5/21"].map((flight) => ({
            val: timeToMinutes(flight.arrival_time),
            label: `${flight.flight_number} | ${flight.departure_time}-${flight.arrival_time}`,
            days: ["21"],
          }));
        }

        // NRT -> MNL (Outbound: 2026/5/20 - arrives 5/21)
        if (flightData["NRT-MNL"] && flightData["NRT-MNL"]["2026/5/20"]) {
          nrtOutboundFlights = flightData["NRT-MNL"]["2026/5/20"].map((flight) => ({
            val: timeToMinutes(flight.arrival_time),
            label: `${flight.flight_number} | ${flight.departure_time}-${flight.arrival_time}`,
            days: ["-1"], // Previous day
          }));
        }

        // MNL -> ENI (Outbound: 2026/5/21)
        if (flightData["MNL-ENI"] && flightData["MNL-ENI"]["2026/5/21"]) {
          eniOutboundFlights = flightData["MNL-ENI"]["2026/5/21"].map((flight) => ({
            val: timeToMinutes(flight.departure_time),
            label: `${flight.flight_number} | ${flight.departure_time}-${flight.arrival_time}`,
            days: ["21"],
          }));
        }

        // ENI -> MNL (Inbound: 5/24 and 5/25)
        if (flightData["ENI-MNL"]) {
          const dates = ["2026/5/24", "2026/5/25"];
          dates.forEach((date, idx) => {
            if (flightData["ENI-MNL"][date]) {
              flightData["ENI-MNL"][date].forEach((flight) => {
                eniInboundFlights.push({
                  val: timeToMinutes(flight.arrival_time),
                  dep: timeToMinutes(flight.departure_time),
                  label: `${flight.flight_number} | ${flight.departure_time}-${flight.arrival_time}`,
                  days: [idx === 0 ? "24" : "25"],
                });
              });
            }
          });
        }

        // MNL -> TPE (Inbound: 5/24 and 5/25)
        if (flightData["MNL-TPE"]) {
          const dates = ["2026/5/24", "2026/5/25"];
          dates.forEach((date, idx) => {
            if (flightData["MNL-TPE"][date]) {
              flightData["MNL-TPE"][date].forEach((flight) => {
                tpeInboundFlights.push({
                  val: timeToMinutes(flight.departure_time),
                  label: `${flight.flight_number} | ${flight.departure_time}-${flight.arrival_time}`,
                  days: [idx === 0 ? "24" : "25"],
                });
              });
            }
          });
        }

        // MNL -> NRT (Inbound: 5/24 and 5/25)
        if (flightData["MNL-NRT"]) {
          const dates = ["2026/5/24", "2026/5/25"];
          dates.forEach((date, idx) => {
            if (flightData["MNL-NRT"][date]) {
              flightData["MNL-NRT"][date].forEach((flight) => {
                nrtInboundFlights.push({
                  val: timeToMinutes(flight.departure_time),
                  label: `${flight.flight_number} | ${flight.departure_time}-${flight.arrival_time}`,
                  days: [idx === 0 ? "24" : "25"],
                });
              });
            }
          });
        }
      }

      // Initialize UI after data is loaded
      function initializeUI() {
        populateOutboundFlights();
        detectAndSetLanguage();
        setReturnDate("24");
        document.querySelectorAll("select").forEach((el) => el.addEventListener("change", calculate));
      }

      // Populate outbound flight selects
      function populateOutboundFlights() {
        const langData = multilingualData[currentLang];

        // TPE outbound
        const tpeOut = document.getElementById("out_tpe");
        tpeOut.innerHTML = `<option value="" disabled selected>${langData.status.select_flight}</option>`;
        tpeOutboundFlights.forEach((flight) => {
          const opt = document.createElement("option");
          opt.value = flight.val;
          opt.setAttribute("data-arr", flight.val);
          opt.textContent = flight.label;
          tpeOut.appendChild(opt);
        });

        // NRT outbound
        const nrtOut = document.getElementById("out_nrt");
        nrtOut.innerHTML = `<option value="" disabled selected>${langData.status.select_flight}</option>`;
        nrtOutboundFlights.forEach((flight) => {
          const opt = document.createElement("option");
          opt.value = flight.val;
          opt.setAttribute("data-day", "-1");
          opt.textContent = flight.label;
          nrtOut.appendChild(opt);
        });

        // ENI outbound
        const eniOut = document.getElementById("out_eni");
        eniOut.innerHTML = `<option value="" disabled selected>${langData.status.select_flight}</option>`;
        eniOutboundFlights.forEach((flight) => {
          const opt = document.createElement("option");
          opt.value = flight.val;
          opt.textContent = flight.label;
          eniOut.appendChild(opt);
        });
      }

      // --- FUNCTIONS ---

      function populateSelect(id, data, date, isExtended) {
        const select = document.getElementById(id);
        const currentVal = select.value;
        const langData = multilingualData[currentLang];
        select.innerHTML = `<option value="" disabled selected>${langData.status.select_flight}</option>`;

        // If isExtended (for MNL outbound), we show Date and Next Date
        const targetDates = [date];
        if (isExtended && date === "24") {
          targetDates.push("25");
        }

        // Create groups if extended
        targetDates.forEach((d) => {
          let groupLabel = `5/${d} å‡ºç™¼`;
          // If it's a simple list (no groups needed if only 1 date), strictly speaking optgroup is nicer but simple list works too.
          // To keep calculation logic simple, we flatten the list but add visual prefix.

          // Sort by time
          const dayData = data.filter((item) => item.days === "all" || item.days.includes(d)).sort((a, b) => a.val - b.val);

          if (dayData.length > 0) {
            // Add separator/header if multiple days
            if (targetDates.length > 1) {
              const group = document.createElement("optgroup");
              group.label = groupLabel;
              select.appendChild(group);
            }

            dayData.forEach((item) => {
              const opt = document.createElement("option");
              opt.value = item.val;
              opt.setAttribute("data-date", d);
              if (item.dep) opt.setAttribute("data-dep", item.dep);

              // Add date prefix for clarity if extended
              const prefix = targetDates.length > 1 ? `[5/${d}] ` : ``;
              opt.textContent = prefix + item.label;

              if (targetDates.length > 1) {
                select.lastChild.appendChild(opt); // Append to optgroup
              } else {
                select.appendChild(opt);
              }
            });
          }
        });

        // Try to keep selection if valid (and date matches)
        // Reset if date changes drastically, but logic handles it
      }

      function setReturnDate(date) {
        currentReturnDate = date;

        // UI Toggle
        document.querySelectorAll(".tab-btn").forEach((b) => {
          b.classList.remove("active", "bg-white", "shadow-sm", "text-teal-700", "bg-teal-50");
          if (b.id === `btn-${date}`) {
            b.classList.add("active");
          }
        });

        // Repopulate Selects
        // ENI -> MNL: Strict (only selected date)
        populateSelect("in_eni", eniInboundFlights, date, false);
        // MNL -> Home: Extended (allow next day if 24th)
        populateSelect("in_tpe", tpeInboundFlights, date, true);
        populateSelect("in_nrt", nrtInboundFlights, date, true);

        calculate();
      }

      function updateDiveWarning(eniSelect) {
        const warningBox = document.getElementById("dive-warning");
        const msgBox = document.getElementById("dive-msg");

        if (!eniSelect.value) {
          warningBox.classList.add("hidden");
          return;
        }

        const selectedOption = eniSelect.options[eniSelect.selectedIndex];
        // Handle optgroup case
        const depMins = parseInt(selectedOption.getAttribute("data-dep"));

        if (isNaN(depMins)) return;

        // Dates logic
        const dateMinus1 = currentReturnDate === "25" ? "24" : "23"; // Day X-1
        const dateCurrent = currentReturnDate; // Day X

        // 1. Calculate 24h Safe Time (Day X-1 same time)
        const h24 = Math.floor(depMins / 60);
        const m24 = depMins % 60;
        const timeStr24 = `${h24.toString().padStart(2, "0")}:${m24.toString().padStart(2, "0")}`;

        // 2. Calculate 18h Minimum Time (Day X-1 same time + 6 hours)
        // 18 hours before flight = (Flight Time - 24h) + 6h
        let mins18 = depMins + 360;
        let date18 = dateMinus1;

        // Handle rollover to next day (if flight is late evening, 18h before might be early morning of flight day)
        if (mins18 >= 1440) {
          mins18 -= 1440;
          date18 = dateCurrent;
        }

        const h18 = Math.floor(mins18 / 60);
        const m18 = mins18 % 60;
        const timeStr18 = `${h18.toString().padStart(2, "0")}:${m18.toString().padStart(2, "0")}`;

        const data = multilingualData[currentLang];
        let htmlContent = `
                <div class="flex flex-col gap-2">
                    <div class="text-slate-600">${data.dive.desc}</div>
                    <div class="flex flex-wrap gap-3">
                        <div class="bg-blue-100 text-blue-900 px-3 py-2 rounded-md border border-blue-200">
                            <span class="text-xs uppercase font-bold tracking-wider opacity-70 block">${data.dive.label_24h}</span>
                            <span class="font-bold text-lg">5/${dateMinus1} ${timeStr24}</span>
                        </div>
                        <div class="bg-orange-100 text-orange-900 px-3 py-2 rounded-md border border-orange-200">
                            <span class="text-xs uppercase font-bold tracking-wider opacity-70 block">${data.dive.label_18h}</span>
                            <span class="font-bold text-lg">5/${date18} ${timeStr18}</span>
                        </div>
                    </div>
                </div>
            `;

        msgBox.innerHTML = htmlContent;
        warningBox.classList.remove("hidden");
      }

      function updateStatus(elementId, gapMinutes, type) {
        const el = document.getElementById(elementId);
        el.classList.remove("hidden");

        const data = multilingualData[currentLang];
        let colorClass, icon, message;
        const hours = Math.floor(gapMinutes / 60);
        const mins = gapMinutes % 60;
        const timeStr = `${hours}h${mins}m`;

        if (gapMinutes < 0) {
          colorClass = "text-red-500 font-bold";
          icon = "ğŸš«";
          message = data.status.impossible;
        } else if (gapMinutes < 150) {
          // < 2.5h
          colorClass = "text-red-600 font-bold";
          icon = "âš¡";
          message = `${data.status.dangerous.replace("åƒ…", timeStr).replace("ã®ã¿", timeStr)}`;
        } else if (gapMinutes < 240) {
          // < 4h
          colorClass = "text-orange-600 font-bold";
          icon = "âœ‹";
          message = `${timeStr} ${data.status.tight}`;
        } else if (gapMinutes > 600) {
          // > 10h
          colorClass = "text-blue-600 font-bold";
          icon = "ğŸ”µ";
          message = `${timeStr} ${data.status.overnight}`;
        } else {
          colorClass = "text-emerald-600 font-bold";
          icon = "âœ¨";
          message = `${timeStr} ${data.status.perfect}`;
        }

        el.innerHTML = `<span class="mr-1">${icon}</span> <span class="${colorClass}">${message}</span>`;
        return gapMinutes;
      }

      function calculate() {
        // OUTBOUND
        const outTpe = document.getElementById("out_tpe").value;
        const outNrt = document.getElementById("out_nrt").value;
        const outEni = document.getElementById("out_eni").value;

        if (outTpe && outEni) {
          const gap = parseInt(outEni) - parseInt(outTpe);
          updateStatus("res_out_tpe", gap, "outbound");
        }

        if (outNrt && outEni) {
          const sel = document.getElementById("out_nrt");
          const isPrevDay = sel.options[sel.selectedIndex].getAttribute("data-day") === "-1";
          let gap;
          if (isPrevDay) {
            gap = 1440 - parseInt(outNrt) + parseInt(outEni);
          } else {
            gap = parseInt(outEni) - parseInt(outNrt);
          }
          updateStatus("res_out_nrt", gap, "outbound");
        }

        // INBOUND
        const inEniSelect = document.getElementById("in_eni");
        const inEni = inEniSelect.value;
        const inTpeSel = document.getElementById("in_tpe");
        const inNrtSel = document.getElementById("in_nrt");

        const inTpe = inTpeSel.value;
        const inNrt = inNrtSel.value;

        // Update Dive Warning
        updateDiveWarning(inEniSelect);

        // Calc Gap with Date Awareness
        if (inEni && inTpe) {
          const eniDate = currentReturnDate;
          const tpeDate = inTpeSel.options[inTpeSel.selectedIndex].getAttribute("data-date");

          let gapTpe;
          if (eniDate === tpeDate) {
            gapTpe = parseInt(inTpe) - parseInt(inEni);
          } else {
            // Assume Next Day
            gapTpe = 1440 - parseInt(inEni) + parseInt(inTpe);
          }
          updateStatus("res_in_tpe", gapTpe, "inbound");
        }

        if (inEni && inNrt) {
          const eniDate = currentReturnDate;
          const nrtDate = inNrtSel.options[inNrtSel.selectedIndex].getAttribute("data-date");

          let gapNrt;
          if (eniDate === nrtDate) {
            gapNrt = parseInt(inNrt) - parseInt(inEni);
          } else {
            gapNrt = 1440 - parseInt(inEni) + parseInt(inNrt);
          }
          updateStatus("res_in_nrt", gapNrt, "inbound");
        }

        // RECOMMENDATION LOGIC
        const recBox = document.getElementById("recommendation");
        const recContent = document.getElementById("rec-content");

        if (inEni) {
          recBox.classList.remove("hidden");
          let recText = "";
          const data = multilingualData[currentLang];

          recText += `<p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${data.recommendation.return_date}${currentReturnDate}</p>`;

          recContent.innerHTML = recText;
        }
      }

      // --- MULTI-LANGUAGE SYSTEM ---

      const multilingualData = {
        ja: {
          nav: {
            brand: "2026El Nido",
            home: "ãƒ›ãƒ¼ãƒ ",
            airline: "ãƒ•ãƒ©ã‚¤ãƒˆäºˆç´„",
            title: "ã‚¨ãƒ«ãƒ‹ãƒ‰ (ENI) ãƒ•ãƒ©ã‚¤ãƒˆãƒ—ãƒ©ãƒ³ãƒŠãƒ¼",
          },
          page: {
            title: "ğŸŒ´ ã‚¨ãƒ«ãƒ‹ãƒ‰ (ENI) ãƒ•ãƒ©ã‚¤ãƒˆãƒ—ãƒ©ãƒ³ãƒŠãƒ¼",
            subtitle: "2026/5/21 å‡ºç™º âœ 5/24 ã¾ãŸã¯ 5/25 å¸°å›½",
          },
          outbound: {
            title: "å¾€è·¯ï¼š2026/5/21 (æœ¨æ›œæ—¥)",
            tpe_label: "ğŸ‡¹ğŸ‡¼ TPE çµŒç”± MNL åˆ°ç€",
            nrt_label: "ğŸ‡¯ğŸ‡µ NRT çµŒç”± MNL åˆ°ç€",
            meeting_point: "é›†åˆåœ°ç‚¹",
            eni_label: "ğŸ‡µğŸ‡­ MNL -> ENI (å…±åŒæ­ä¹—)",
          },
          inbound: {
            title_prefix: "ENI å‡ºç™ºæ—¥ï¼š",
            date_24: "5/24 (æ—¥æ›œ)",
            date_25: "5/25 (æœˆæ›œ)",
            departure_point: "å‡ºç™ºåœ°ç‚¹",
            eni_label: "ğŸ‡µğŸ‡­ ENI -> MNL (å…±åŒæ­ä¹—)",
            tpe_label: "ğŸ‡¹ğŸ‡¼ MNL ç™º TPE è¡Œã",
            nrt_label: "ğŸ‡¯ğŸ‡µ MNL ç™º NRT è¡Œã",
          },
          dive: {
            title: "ãƒ€ã‚¤ãƒãƒ¼ã¸ã®ãŠçŸ¥ã‚‰ã›",
            desc: "ã“ã®ãƒ•ãƒ©ã‚¤ãƒˆã‚’ã”åˆ©ç”¨ã®å ´åˆã€æ¨å¥¨ã•ã‚Œã‚‹æœ€çµ‚ãƒ€ã‚¤ãƒ–çµ‚äº†æ™‚é–“ï¼š",
            label_24h: "24æ™‚é–“å‰ (æ¨å¥¨)",
            label_18h: "18æ™‚é–“å‰ (æœ€ä½)",
          },
          status: {
            impossible: "æ¥ç¶šä¸å¯ (ãƒ•ãƒ©ã‚¤ãƒˆå‡ºç™ºæ¸ˆã¿)",
            dangerous: "ã®ã¿ (æ¥µã‚ã¦å±é™º)",
            tight: "æ®‹ã‚Š (ã‚„ã‚„æ€¥ã)",
            overnight: "ä¹—ã‚Šç¶™ã (å®¿æ³Šå¿…è¦)",
            perfect: "æ®‹ã‚Š (å®Œç’§)",
            select_flight: "ãƒ•ãƒ©ã‚¤ãƒˆã‚’é¸æŠ...",
          },
          recommendation: {
            title: "âœ¨ æ—…ç¨‹åˆ†æã¨ææ¡ˆ",
            return_date: "å¸°å›½æ—¥ï¼š5/",
          },
        },
        "zh-TW": {
          nav: {
            brand: "2026El Nido",
            home: "é¦–é ",
            airline: "èˆªç­è¦åŠƒ",
            title: "æ„›å¦®å³¶ (ENI) èˆªç­è¦åŠƒ",
          },
          page: {
            title: "ğŸŒ´ æ„›å¦®å³¶ (ENI) èˆªç­è¦åŠƒ",
            subtitle: "2026/5/21 å‡ºç™¼ âœ 5/24 æˆ– 5/25 å›ç¨‹",
          },
          outbound: {
            title: "å»ç¨‹ï¼š2026/5/21 (é€±å››)",
            tpe_label: "ğŸ‡¹ğŸ‡¼ TPE æŠµé” MNL",
            nrt_label: "ğŸ‡¯ğŸ‡µ NRT æŠµé” MNL",
            meeting_point: "æœƒåˆé»",
            eni_label: "ğŸ‡µğŸ‡­ MNL -> ENI (å…±åŒæ­ä¹˜)",
          },
          inbound: {
            title_prefix: "ENI å‡ºç™¼æ—¥æœŸï¼š",
            date_24: "5/24 (é€±æ—¥)",
            date_25: "5/25 (é€±ä¸€)",
            departure_point: "å‡ºç™¼é»",
            eni_label: "ğŸ‡µğŸ‡­ ENI -> MNL (å…±åŒæ­ä¹˜)",
            tpe_label: "ğŸ‡¹ğŸ‡¼ MNL èµ·é£›å¾€ TPE",
            nrt_label: "ğŸ‡¯ğŸ‡µ MNL èµ·é£›å¾€ NRT",
          },
          dive: {
            title: "æ½›æ°´å“¡æº«é¦¨æé†’",
            desc: "æ­ä¹˜æ­¤ç­æ©Ÿï¼Œå»ºè­°æœ€å¾Œä¸€æ¬¡æ½›æ°´çµæŸæ™‚é–“ï¼š",
            label_24h: "24å°æ™‚å‰ (æ¨è–¦)",
            label_18h: "18å°æ™‚å‰ (æœ€ä½)",
          },
          status: {
            impossible: "ç„¡æ³•éŠœæ¥ (ç­æ©Ÿå·²é£›èµ°)",
            dangerous: "åƒ… (æ¥µå±éšª)",
            tight: "å‰© (ç¨è¶•)",
            overnight: "è½‰æ©Ÿ (éœ€éå¤œ)",
            perfect: "å‰© (å®Œç¾)",
            select_flight: "é¸æ“‡èˆªç­...",
          },
          recommendation: {
            title: "âœ¨ è¡Œç¨‹åˆ†æèˆ‡å»ºè­°",
            return_date: "å›ç¨‹æ—¥æœŸï¼š5/",
          },
        },
      };

      const defaultLang = "zh-TW";
      let currentLang = defaultLang;

      const getNestedValue = (obj, path) => {
        return path.split(".").reduce((acc, part) => acc && acc[part], obj);
      };

      function updateUI(lang) {
        currentLang = lang;
        const data = multilingualData[lang];

        // Update Title
        document.title = data.nav.title;

        // Update all elements with data-key attribute
        document.querySelectorAll("[data-key]").forEach((el) => {
          const key = el.getAttribute("data-key");
          const value = getNestedValue(data, key);

          if (value !== undefined) {
            if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
              el.value = value;
            } else {
              el.innerHTML = value.replace(/\n/g, "<br>");
            }
          }
        });
      }

      function switchLanguage(lang) {
        updateUI(lang);
        saveLanguagePreference(lang);
      }

      function saveLanguagePreference(lang) {
        localStorage.setItem("preferred-language", lang);
      }

      function loadLanguagePreference() {
        const savedLang = localStorage.getItem("preferred-language");
        return savedLang || defaultLang;
      }

      function toggleMobileMenu() {
        const menu = document.getElementById("mobile-menu");
        menu.classList.toggle("hidden");
      }

      function detectAndSetLanguage() {
        let detectedLang = defaultLang;

        // Check localStorage first
        const savedLang = loadLanguagePreference();
        if (savedLang && multilingualData[savedLang]) {
          detectedLang = savedLang;
        } else {
          // Fall back to browser language
          const browserLangs = navigator.languages || [navigator.language || navigator.userLanguage];

          for (const browserLang of browserLangs) {
            const standardizedLang = browserLang.toLowerCase();

            if (multilingualData[standardizedLang]) {
              detectedLang = standardizedLang;
              break;
            }

            const baseLang = standardizedLang.split("-")[0];
            if (baseLang === "ja" && multilingualData["ja"]) {
              detectedLang = "ja";
              break;
            }
            if (baseLang === "zh" && multilingualData["zh-TW"]) {
              detectedLang = "zh-TW";
              break;
            }
          }
        }

        // Set the selector and update UI
        const selector = document.getElementById("language-selector");
        if (selector) {
          selector.value = detectedLang;
        }
        updateUI(detectedLang);
      }

      // INIT
      loadFlightData();
    </script>
  </body>
</html>
